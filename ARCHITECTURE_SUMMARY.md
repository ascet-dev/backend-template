# Архитектура приложения с управлением жизненным циклом

## Обзор

Создана полноценная архитектура для управления жизненным циклом приложения и его компонентов с поддержкой различных типов зависимостей и областей видимости.

## Ключевые особенности

### 1. Управление жизненным циклом

- **Автоматическая инициализация** компонентов при запуске приложения
- **Корректное завершение** работы всех компонентов при остановке
- **Управление состояниями** компонентов (UNINITIALIZED, INITIALIZING, READY, STOPPING, STOPPED, ERROR)

### 2. Типы жизненного цикла

- **Singleton** - один экземпляр на всё приложение (подходит для подключений к БД, HTTP клиентов)
- **Request** - новый экземпляр на каждый запрос (подходит для сессий, контекста запроса)
- **Transient** - новый экземпляр при каждом обращении (подходит для сервисов без состояния)

### 3. Управление зависимостями

- **Автоматическое разрешение зависимостей** между компонентами
- **Поддержка фабрик** для создания компонентов с параметрами
- **Переиспользование ресурсов** (например, HTTP клиент с пулом соединений)

### 4. Мониторинг и отладка

- **Health checks** для всех компонентов
- **Проверка состояния** приложения и компонентов
- **Обработка ошибок** при инициализации и завершении

## Структура файлов

```
architecture/
├── __init__.py              # Экспорт основных классов
├── interfaces.py            # Базовые интерфейсы
├── container.py             # Контейнер зависимостей
├── application.py           # Базовый класс приложения
├── components.py            # Примеры компонентов
├── examples.py              # Примеры использования
├── requirements.txt         # Зависимости
├── README.md               # Основная документация
├── ARCHITECTURE.md         # Диаграммы архитектуры
└── USAGE.md                # Руководство по использованию
```

## Основные классы

### 1. ApplicationBuilder

```python
app = (ApplicationBuilder()
       .with_singleton(IHttpClient, HttpClientComponent)
       .with_factory(DatabaseComponent, create_database, "singleton")
       .build())
```

### 2. Application

```python
async with app:
    # Работа с приложением
    component = app.get_component("component_name")
    health = await app.health_check()
```

### 3. DependencyContainer

- Управление регистрацией компонентов
- Разрешение зависимостей
- Создание экземпляров с правильным жизненным циклом

### 4. Компоненты

- **HttpClientComponent** - HTTP клиент с пулом соединений
- **DatabaseComponent** - подключение к PostgreSQL
- **S3Component** - работа с S3
- **KafkaComponent** - работа с Kafka
- **SessionComponent** - управление сессиями

## Примеры использования

### Простое приложение

```python
app = (ApplicationBuilder()
       .with_singleton(IHttpClient, HttpClientComponent)
       .build())

async with app:
    http_client = app.get_component("http_client")
    response = await http_client.get("https://api.example.com/data")
```

### Приложение с зависимостями

```python
def create_database(http_client: IHttpClient) -> DatabaseComponent:
    return DatabaseComponent(config, http_client)

app = (ApplicationBuilder()
       .with_singleton(IHttpClient, HttpClientComponent)
       .with_factory(DatabaseComponent, create_database, "singleton")
       .build())
```

### Request-scoped компоненты

```python
async with app.request_scope():
    session = SessionComponent("session_123")
    await session.initialize()
    # Сессия автоматически очистится при выходе из scope
```

## Преимущества архитектуры

1. **Разделение ответственности** - каждый компонент отвечает за свою область
2. **Управление зависимостями** - автоматическое разрешение зависимостей
3. **Жизненный цикл** - четкое управление инициализацией и завершением
4. **Переиспользование ресурсов** - HTTP клиент с пулом соединений
5. **Гибкость** - поддержка разных типов жизненного цикла
6. **Тестируемость** - легко мокать компоненты для тестов
7. **Мониторинг** - встроенные health checks
8. **Безопасность** - корректное завершение работы всех компонентов

## Тестирование

Создан полный набор тестов с мок-компонентами, демонстрирующий:

- Простое приложение
- Приложение с зависимостями
- Request-scoped компоненты
- Кастомное приложение с бизнес-логикой

Все тесты проходят успешно и демонстрируют работу архитектуры.

## Расширяемость

Архитектура легко расширяется:

- Добавление новых компонентов
- Создание кастомных приложений
- Интеграция с различными сервисами
- Поддержка новых типов жизненного цикла

## Заключение

Созданная архитектура предоставляет:

- **Удобный интерфейс** для сборки приложения
- **Гибкое управление** жизненным циклом компонентов
- **Автоматическое разрешение** зависимостей
- **Поддержку различных** типов жизненного цикла
- **Переиспользование ресурсов** (HTTP соединения)
- **Полную документацию** и примеры использования

Архитектура готова к использованию в реальных проектах и может быть легко адаптирована под конкретные требования.

